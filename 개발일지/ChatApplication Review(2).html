<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/9d2484721dfb0fa3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9d2484721dfb0fa3.css" data-n-g=""/><link rel="preload" href="/_next/static/css/d837742cb9035689.css" as="style"/><link rel="stylesheet" href="/_next/static/css/d837742cb9035689.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-35b92941fc8726f9.js" defer=""></script><script src="/_next/static/chunks/framework-381da54bc5986544.js" defer=""></script><script src="/_next/static/chunks/main-d08cdb1c11d062c5.js" defer=""></script><script src="/_next/static/chunks/pages/_app-e6411096b10c6b62.js" defer=""></script><script src="/_next/static/chunks/441-45d334119e93ce4f.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bcategory%5D/%5Btitle%5D-54be7db8139f8b64.js" defer=""></script><script src="/_next/static/x7KlanTMcx7BnykrAqYzT/_buildManifest.js" defer=""></script><script src="/_next/static/x7KlanTMcx7BnykrAqYzT/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><header class="page-header"><h1 class="project-name">ChatApplication Review(2)</h1><h1 class="project-subtitle">컨테이너화, ChatDBManager</h1></header><main id="content" class="main-content"><div><aside id="category-list" aria-label="Category List"><h2>Categories</h2><ul><li><a href="/ETC">ETC</a></li><li><a href="/개발이야기">개발이야기</a></li><li><a href="/개발일지">개발일지</a></li><li><a href="/디자인패턴">디자인패턴</a></li><li><a href="/Algorithm">Algorithm</a></li><li><a href="/서평">서평</a></li><li><a href="/WeeklyPosts">WeeklyPosts</a></li><li><a href="/신변잡기">신변잡기</a></li><li><a href="/게임이야기">게임이야기</a></li></ul></aside><div>
      <h2 id="목차">
        <a name="목차" class="anchor" href="#목차">
          <span class="header-link"></span>
        </a>
        목차
      </h2><ol>
<li>느낀 점</li>
<li>진행 내용</li>
<li>문제 및 해결 방법</li>
</ol>
<hr>

      <h2 id="느낀-점">
        <a name="느낀-점" class="anchor" href="#느낀-점">
          <span class="header-link"></span>
        </a>
        느낀 점
      </h2><p>단순히 프로그램이 동작하는 것을 넘어서, 오랜 기간동안 개발 및 유지될 것을 고려하면 많은 부분이 달라진다는 것을 경험할 수 있었다. unittest들이 작성돼있었던 덕분에 sessionManager 같은 것들을 refactor했는데도 동작이 여전히 가능하단 것을 쉽게 확인할 수 있었지만, 동시에 이를 자동화하기 위한 방법도 고려해 둬야한다는 것도 알 수 있었다.</p>
<p>또한 이후 개발에 있어서 현재 예측할 수 없는 스펙 부분에 대응하기 위해 가능한 많은 부분을 유연하게 만들어두는 것이 중요하다는 것도 알 수 있었다. 내가 현재 생각해 둔 디렉토리의 형태부터 시작해서 변수/파일명, 인터페이스 접근 방식 등 생각보다 훨씬 많은 것들에 대해 유연하게 대응할 수 있도록 만들어둘 수 있는 부분이 많았다.</p>
<p>그리고 containerization이 끝났다 해서 이를 remote cloud server에 올리는 것이 단순하지만은 않다는 것도 느낀다.</p>
<hr>

      <h2 id="진행-내용">
        <a name="진행-내용" class="anchor" href="#진행-내용">
          <span class="header-link"></span>
        </a>
        진행 내용
      </h2><ul>
<li>배포를 위한 containerization 작업 완료</li>
<li>채팅 기능을 위한 모듈들의 기본적인 구조 설계 및 이에 따른 구조 refactoring</li>
<li>채팅에서 사용할 mongodb 인터페이스 설계</li>
</ul>
<hr>

      <h2 id="문제-및-해결-방법">
        <a name="문제-및-해결-방법" class="anchor" href="#문제-및-해결-방법">
          <span class="header-link"></span>
        </a>
        문제 및 해결 방법
      </h2>
      <h3 id="문제:-빌드한-어플리케이션이-로컬에서와-다르게-동작함">
        <a name="문제:-빌드한-어플리케이션이-로컬에서와-다르게-동작함" class="anchor" href="#문제:-빌드한-어플리케이션이-로컬에서와-다르게-동작함">
          <span class="header-link"></span>
        </a>
        문제: 빌드한 어플리케이션이 로컬에서와 다르게 동작함
      </h3><ol>
<li>postgresql과의 연결이 안됨<ul>
<li>기존에 hostname이 localhost로 돼있었는데, containerization을 할 경우 이를 postgresql로 DBManager를 바꿔야하기 때문.</li>
<li>로컬에서 테스트할 경우에 문제가 되는 부분이기 때문에 이를 양쪽 환경에서 다르게 쓸 방법을 찾아야함.</li>
</ul>
</li>
<li>Failed to process session key 에러가 발생하고 있음.<ul>
<li>이는 로컬에서는 발생하지 않았던 에러로, 이를 해결하기 위해선 어떤 부분이 문제인지 파악해야함.</li>
<li>이를 위해선 로컬에서와 동일한 환경을 만들어야함.</li>
<li>postgresql과 마찬가지로 hostname을 localhost를 쓰던 것이 문제였고, 이를 redis로 바꿔야함.</li>
</ul>
</li>
</ol>

      <h3 id="해결-방법:">
        <a name="해결-방법:" class="anchor" href="#해결-방법:">
          <span class="header-link"></span>
        </a>
        해결 방법:
      </h3><ul>
<li><p>ENV를 사용하여 환경변수를 설정하고, 없을 경우에는 default인 localhost를 사용하게 해서 local에서 동작하도록 변경함.</p>
</li>
<li><p>해당 ENV는 docker-compose.yml와 dockerfile에서 사용하도록 변경함.</p>
</li>
<li><p><a target="_self" href="https://github.com/kaestro/ChatApplication/commit/e6258879d661345d7aeeac0a05ed953e8bd05a0e" title="null">https://github.com/kaestro/ChatApplication/commit/e6258879d661345d7aeeac0a05ed953e8bd05a0e</a></p>
</li>
<li><p>ex)</p>
<ul>
<li>before)</li>
</ul>
</li>
</ul>
<pre><code class="language-go">func GetDBManager() *DBManager {
    once.Do(func() {
        var err error
        db, err := gorm.Open(&quot;postgres&quot;, &quot;postgres://postgres:rootpassword@postgresql:5432/postgres?sslmode=disable&quot;)
        if err != nil {
            panic(err)
        }
</code></pre>
<pre><code>* after)
</code></pre>
<pre><code class="language-go">func GetDBManager() *DBManager {
    once.Do(func() {
        var err error
        dbURL := os.Getenv(&quot;DB_URL&quot;)
        if dbURL == &quot;&quot; {
            dbURL = &quot;postgres://postgres:rootpassword@localhost:5432/postgres?sslmode=disable&quot; // default value
        }
        db, err := gorm.Open(&quot;postgres&quot;, dbURL)
        if err != nil {
            panic(err)
        }
</code></pre>
<hr>

      <h3 id="문제:-몽고-db의-인터페이스-설정">
        <a name="문제:-몽고-db의-인터페이스-설정" class="anchor" href="#문제:-몽고-db의-인터페이스-설정">
          <span class="header-link"></span>
        </a>
        문제: 몽고 db의 인터페이스 설정
      </h3><ol>
<li>허용하고자 하는 동작은 어느 것들이 있는가</li>
<li>기존의 디렉토리와 함께했을 때 구성은 어떻게 해야하는가</li>
</ol>
<ul>
<li>models같은 경우에는 api/models 디렉토리 상에 위치하고 있는데, 이를 몽고 db의 internal에서도 사용해야하는 시점에서 디렉토리 구성을 개선할 필요가 발생함.</li>
</ul>

      <h3 id="해결-방법:">
        <a name="해결-방법:" class="anchor" href="#해결-방법:">
          <span class="header-link"></span>
        </a>
        해결 방법:
      </h3><ol>
<li>일단 나머지 모듈들을 만들어서 테스트하는 데에 필요한 AddMessage, GetMessages, CreateChatRoom, GetChatRooms 정도의 함수를 만든다.</li>
<li>internal/db/mongodb 디렉토리를 만들고 여기에 ChatDBManager.go를 만들어 몽고 db들 중 chat에 한정한 인터페이스로 이번에 작성한 모듈이 국한되도록 한다.</li>
</ol>
</div><div style="display:flex;flex-direction:column;gap:1em"><div><a href="/개발일지/ChatApplication Review(1)">이전 포스트: <!-- -->ChatApplication Review(1)</a></div><div style="text-align:right"><a href="/개발일지/ChatApplication Review(3)">다음 포스트: <!-- -->ChatApplication Review(3)</a></div></div><div><button id="go-home" class="home-button-container">Home</button></div><div><button type="button" id="go-top" class="scroll-top" aria-label="top"></button></div><div><button type="button" id="go-bottom" class="scroll-bottom" aria-label="bottom"></button></div></div><hr/></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postDataJson":{"postName":"2024-02-27-Chat Application review(2)","fullPath":"/home/runner/work/kaestro.github.io/kaestro.github.io/_posts/개발/개발일지/Chat Application 개발일지/2024-02-27-Chat Application review(2).md","category":"개발일지","title":"ChatApplication Review(2)","subtitle":"컨테이너화, ChatDBManager","content":"\n\n## 목차\n\n1. 느낀 점\n2. 진행 내용\n3. 문제 및 해결 방법\n\n\n---\n\n\n## 느낀 점\n\n\n단순히 프로그램이 동작하는 것을 넘어서, 오랜 기간동안 개발 및 유지될 것을 고려하면 많은 부분이 달라진다는 것을 경험할 수 있었다. unittest들이 작성돼있었던 덕분에 sessionManager 같은 것들을 refactor했는데도 동작이 여전히 가능하단 것을 쉽게 확인할 수 있었지만, 동시에 이를 자동화하기 위한 방법도 고려해 둬야한다는 것도 알 수 있었다.\n\n또한 이후 개발에 있어서 현재 예측할 수 없는 스펙 부분에 대응하기 위해 가능한 많은 부분을 유연하게 만들어두는 것이 중요하다는 것도 알 수 있었다. 내가 현재 생각해 둔 디렉토리의 형태부터 시작해서 변수/파일명, 인터페이스 접근 방식 등 생각보다 훨씬 많은 것들에 대해 유연하게 대응할 수 있도록 만들어둘 수 있는 부분이 많았다.\n\n그리고 containerization이 끝났다 해서 이를 remote cloud server에 올리는 것이 단순하지만은 않다는 것도 느낀다.\n\n---\n\n\n## 진행 내용\n\n* 배포를 위한 containerization 작업 완료\n* 채팅 기능을 위한 모듈들의 기본적인 구조 설계 및 이에 따른 구조 refactoring\n* 채팅에서 사용할 mongodb 인터페이스 설계\n\n---\n\n## 문제 및 해결 방법\n\n### 문제: 빌드한 어플리케이션이 로컬에서와 다르게 동작함\n  1. postgresql과의 연결이 안됨\n     * 기존에 hostname이 localhost로 돼있었는데, containerization을 할 경우 이를 postgresql로 DBManager를 바꿔야하기 때문.\n     * 로컬에서 테스트할 경우에 문제가 되는 부분이기 때문에 이를 양쪽 환경에서 다르게 쓸 방법을 찾아야함.\n  2. Failed to process session key 에러가 발생하고 있음.\n\t * 이는 로컬에서는 발생하지 않았던 에러로, 이를 해결하기 위해선 어떤 부분이 문제인지 파악해야함.\n\t * 이를 위해선 로컬에서와 동일한 환경을 만들어야함.\n\t * postgresql과 마찬가지로 hostname을 localhost를 쓰던 것이 문제였고, 이를 redis로 바꿔야함.\n   \n### 해결 방법:\n  * ENV를 사용하여 환경변수를 설정하고, 없을 경우에는 default인 localhost를 사용하게 해서 local에서 동작하도록 변경함.\n  * 해당 ENV는 docker-compose.yml와 dockerfile에서 사용하도록 변경함.\n   * [https://github.com/kaestro/ChatApplication/commit/e6258879d661345d7aeeac0a05ed953e8bd05a0e](https://github.com/kaestro/ChatApplication/commit/e6258879d661345d7aeeac0a05ed953e8bd05a0e)\n  * ex)\n\n    * before)\n```go\nfunc GetDBManager() *DBManager {\n\tonce.Do(func() {\n\t\tvar err error\n\t\tdb, err := gorm.Open(\"postgres\", \"postgres://postgres:rootpassword@postgresql:5432/postgres?sslmode=disable\")\n\t\tif err != nil {\n\t\t\tpanic(err)\n\t\t}\n```\n\n\t* after)\n```go\nfunc GetDBManager() *DBManager {\n\tonce.Do(func() {\n\t\tvar err error\n\t\tdbURL := os.Getenv(\"DB_URL\")\n\t\tif dbURL == \"\" {\n\t\t\tdbURL = \"postgres://postgres:rootpassword@localhost:5432/postgres?sslmode=disable\" // default value\n\t\t}\n\t\tdb, err := gorm.Open(\"postgres\", dbURL)\n\t\tif err != nil {\n\t\t\tpanic(err)\n\t\t}\n```\n\n---\n\n### 문제: 몽고 db의 인터페이스 설정\n\n1. 허용하고자 하는 동작은 어느 것들이 있는가\n2. 기존의 디렉토리와 함께했을 때 구성은 어떻게 해야하는가\n  * models같은 경우에는 api/models 디렉토리 상에 위치하고 있는데, 이를 몽고 db의 internal에서도 사용해야하는 시점에서 디렉토리 구성을 개선할 필요가 발생함.\n\n### 해결 방법:\n\n1. 일단 나머지 모듈들을 만들어서 테스트하는 데에 필요한 AddMessage, GetMessages, CreateChatRoom, GetChatRooms 정도의 함수를 만든다.\n2. internal/db/mongodb 디렉토리를 만들고 여기에 ChatDBManager.go를 만들어 몽고 db들 중 chat에 한정한 인터페이스로 이번에 작성한 모듈이 국한되도록 한다.","layout":"series","recommended":false,"data":{"layout":"series","series":"Chat Application 개발일지","seriesIndex":2,"classes":"wide","title":"ChatApplication Review(2)","subtitle":"컨테이너화, ChatDBManager","date":"2024-02-27T00:00:00.000Z","categories":"개발일지"}},"title":"ChatApplication Review(2)","category":"개발일지","categories":["ETC","개발이야기","개발일지","디자인패턴","Algorithm","서평","WeeklyPosts","신변잡기","게임이야기"],"adjacentPosts":{"prev":{"title":"ChatApplication Review(1)","category":"개발일지"},"next":{"title":"ChatApplication Review(3)","category":"개발일지"}}},"__N_SSG":true},"page":"/[category]/[title]","query":{"category":"개발일지","title":"ChatApplication Review(2)"},"buildId":"x7KlanTMcx7BnykrAqYzT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>