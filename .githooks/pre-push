#!/bin/bash
# pre-push hook: 원격 저장소와 동기화 후 push 진행
# GitHub Actions 워크플로우로 인한 원격 커밋 충돌 방지

# 색상 정의
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# main 브랜치만 동기화
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo -e "${GREEN}[pre-push] main 브랜치가 아니므로 동기화 스킵${NC}"
    exit 0
fi

echo -e "${YELLOW}[pre-push] 원격 저장소 동기화 확인...${NC}"
git fetch origin "$CURRENT_BRANCH" 2>/dev/null

LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse "origin/$CURRENT_BRANCH" 2>/dev/null)
BASE=$(git merge-base HEAD "origin/$CURRENT_BRANCH" 2>/dev/null)

if [ "$LOCAL" = "$REMOTE" ]; then
    echo -e "${GREEN}[pre-push] 이미 동기화됨${NC}"
    exit 0
elif [ "$REMOTE" = "$BASE" ]; then
    echo -e "${GREEN}[pre-push] 로컬이 앞서 있음. 정상 push 진행${NC}"
    exit 0
else
    echo -e "${YELLOW}[pre-push] 원격에 새 커밋 발견. rebase 실행...${NC}"
    if git pull --rebase origin "$CURRENT_BRANCH"; then
        echo -e "${GREEN}[pre-push] 동기화 완료!${NC}"
        exit 0
    else
        echo -e "${RED}[pre-push] rebase 실패. 수동으로 충돌 해결 필요${NC}"
        echo -e "${RED}다음 명령으로 rebase 중단 가능: git rebase --abort${NC}"
        exit 1
    fi
fi
